<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#0b63ff">
  <link rel="manifest" href="/manifest.json">
  <title>PWA Calculator</title>
  <style>
    /* Minimal, accessible styling */
    :root{--bg:#f6f8fb;--card:#fff;--accent:#0b63ff;--muted:#666}
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .app{min-height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#eef5ff,white)}
    .card{width:360px;background:var(--card);box-shadow:0 10px 30px rgba(20,30,60,.08);border-radius:12px;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    h1{font-size:1.1rem;margin:0}
    #display{background:#f3f6fb;border-radius:8px;padding:12px;font-size:1.6rem;text-align:right;min-height:48px;display:flex;align-items:center;justify-content:flex-end}
    #keys{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
    button.key{padding:14px;border-radius:8px;border:0;background:#f1f5fb;font-size:1rem}
    button.key.operator{background:linear-gradient(180deg,#0b63ff,#0849d1);color:white}
    .row{display:flex;gap:8px}
    .muted{color:var(--muted);font-size:.85rem}
    .controls{display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:#eee}
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:white;padding:10px 14px;border-radius:10px;display:none}
  </style>
</head>
<body class="app">
  <main class="card" role="application" aria-label="Calculator">
    <header>
      <h1>PWA Calculator</h1>
      <div class="controls">
        <button id="installBtn" class="btn" aria-hidden="false">Download Now</button>
        <button id="clearCache" class="btn" title="Clear cached app (for testing)">Clear Cache</button>
      </div>
    </header>

    <div id="display" role="status" aria-live="polite">0</div>

    <div id="keys" aria-hidden="false">
      <button class="key" data-value="7">7</button>
      <button class="key" data-value="8">8</button>
      <button class="key" data-value="9">9</button>
      <button class="key operator" data-value="/">÷</button>

      <button class="key" data-value="4">4</button>
      <button class="key" data-value="5">5</button>
      <button class="key" data-value="6">6</button>
      <button class="key operator" data-value="*">×</button>

      <button class="key" data-value="1">1</button>
      <button class="key" data-value="2">2</button>
      <button class="key" data-value="3">3</button>
      <button class="key operator" data-value="-">−</button>

      <button class="key" data-value="0">0</button>
      <button class="key" data-value=".">.</button>
      <button class="key" id="equals" class="key operator" data-value="=">=</button>
      <button class="key operator" data-value="+">+</button>

      <button class="key" id="back" style="grid-column:span 2">⌫</button>
      <button class="key" id="clear" style="grid-column:span 2">C</button>
    </div>

    <p class="muted" id="statusMsg">Offline-ready. Installable PWA.</p>
  </main>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    // --- Calculator logic (client-side) ---
    (function(){
      const display = document.getElementById('display');
      let expr = '';
      function render(){ display.textContent = expr || '0' }
      function safeEval(s){
        // very small safe expression evaluator: allow digits, operators, parentheses, dot
        if(!/^[0-9+\-*/(). \t]+$/.test(s)) throw new Error('Invalid characters');
        // prevent accidental huge exponents or long runs
        if(s.length>200) throw new Error('Expression too long');
        // eslint-disable-next-line no-eval
        return Function('return ('+s+')')();
      }
      document.getElementById('keys').addEventListener('click', e=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const v = btn.dataset.value;
        if(v==null) return;
        if(v==='='){ try{ expr = String(safeEval(expr)); }catch(err){ showToast(err.message); expr=''; } render(); return }
        if(v==='.'){ if(expr.endsWith('.')) return; expr += '.'; render(); return }
        if(v==='+'||v==='-'||v==='*'||v==='/'){ expr += v; render(); return }
        // numbers
        if(v.match(/^[0-9]$/)){ expr += v; render(); return }
      });
      document.getElementById('clear').addEventListener('click', ()=>{ expr=''; render(); })
      document.getElementById('back').addEventListener('click', ()=>{ expr=expr.slice(0,-1); render(); })
      // keyboard support
      window.addEventListener('keydown', e=>{
        if(e.key==='Enter'){ try{ expr=String(safeEval(expr)); }catch(err){ showToast(err.message); expr=''; } render(); e.preventDefault(); }
        if(e.key==='Backspace'){ expr=expr.slice(0,-1); render(); }
        if(e.key==='Escape'){ expr=''; render(); }
        if(/^[0-9+\-*/().]$/.test(e.key)){ expr += e.key; render(); }
      })
      function showToast(msg, ms=3000){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms) }

      // --- PWA: install prompt handling ---
      let deferredPrompt = null;
      const installBtn = document.getElementById('installBtn');
      window.addEventListener('beforeinstallprompt', (e)=>{
        e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block';
      });
      installBtn.addEventListener('click', async ()=>{
        if(!deferredPrompt) return;
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        deferredPrompt = null; installBtn.style.display='none';
        showToast(choice.outcome==='accepted' ? 'Installed' : 'Install dismissed');
      });

      // --- Service Worker update notification ---
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('/sw.js').then(reg=>{
          // listen for updates
          reg.addEventListener('updatefound', ()=>{
            const newSW = reg.installing;
            newSW.addEventListener('statechange', ()=>{
              if(newSW.state==='installed'){
                if(navigator.serviceWorker.controller){
                  // new update available
                  showToast('New version available — refresh to update', 6000);
                } else {
                  showToast('App is ready for offline use.');
                }
              }
            })
          })
        }).catch(err=>console.error('sw register failed',err))
      }

      // Clear cache button (test only)
      document.getElementById('clearCache').addEventListener('click', async ()=>{
        if('caches' in window){ const keys = await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); showToast('Cache cleared'); }
      })

      render();
    })();
  </script>
</body>
</html>
